# BabyEase NativeWind - Project Rules & Best Practices

## Core Architecture

- **React Native** with **Expo 54+** (New Architecture)
- **Expo Router** for file-based routing
- **NativeWind 4** (Tailwind CSS) for styling - NO StyleSheet.create()
- **Clerk Auth** for authentication
- **SQLite** with Drizzle ORM
- **React Native Reusables** component library (shadcn/ui pattern)

## Code Organization Philosophy (CRITICAL)

### NO UNNECESSARY ABSTRACTIONS
**Keep code simple and maintainable - avoid extra layers without clear value**

#### Query Keys - Centralized for Uniqueness
**All React Query keys must be in `constants/query-keys.ts`** for global uniqueness:

```typescript
// constants/query-keys.ts
export const FEEDINGS_QUERY_KEY = ['feedings'] as const;
export const feedingByIdKey = (id: number) => ['feeding', id] as const;
```

Why centralized:
- Prevents key collisions across features
- Easy to audit all cache keys in one place
- Ensures consistent naming patterns

#### Database Module Pattern
Each database module (e.g., `database/feeding.ts`) contains:
1. **Database CRUD functions**
2. **Feature-specific types** (if needed)

```typescript
// database/feeding.ts
export async function getFeedings() {
  return await db.select().from(schema.feedings);
}

export async function getFeedingById(id: number) {
  return await db.select().from(schema.feedings).where(eq(schema.feedings.id, id));
}
```

#### Component Data Fetching Pattern
Use React Query's `useQuery` directly - **NO custom hooks wrappers**:

```typescript
// ‚úÖ CORRECT - Direct usage
import { useQuery } from '@tanstack/react-query';
import { getFeedings } from '@/database/feeding';
import { FEEDINGS_QUERY_KEY } from '@/constants/query-keys';

function FeedingScreen() {
  const { data, isLoading } = useQuery({
    queryKey: FEEDINGS_QUERY_KEY,
    queryFn: getFeedings,
    staleTime: 5 * 60 * 1000,
  });
}

// ‚ùå WRONG - Don't create hooks/use-feedings.ts
export function useFeedings() {
  return useQuery({ queryKey: FEEDINGS_QUERY_KEY, queryFn: getFeedings });
}
```

#### When Custom Hooks ARE Appropriate
Only create custom hooks when they:
- Combine multiple queries with complex selection logic
- Handle stateful UI interactions (modal state, form validation)
- Manage side effects beyond simple data fetching

#### Organization Summary
- ‚úÖ Query keys in `constants/query-keys.ts` (global uniqueness)
- ‚úÖ Database functions in `database/*.ts` (feature-specific)
- ‚úÖ Direct `useQuery` in components (no wrappers)
- ‚ùå Don't create wrapper hooks in `hooks/use-*.ts` for simple queries

## Styling Rules (CRITICAL)

### Never Use StyleSheet
- ‚ùå **NEVER** use `StyleSheet.create()` or inline `style={{ ... }}`
- ‚úÖ **ALWAYS** use Tailwind utility classes via `className` prop
- Use `cn()` from `@/lib/utils` to merge Tailwind classes

### NativeWind Shadow Classes Exception
- ‚ö†Ô∏è **EXCEPTION**: Shadow classes (`shadow-*`) on `Pressable`/`TouchableOpacity` cause navigation context errors
- ‚úÖ Use native `style` prop for shadows on pressable components (see Common Gotchas)
- ‚úÖ Shadow classes are safe on `View` components

### Theme Colors
- Brand colors: `bg-primary` (#5B7FFF), `bg-accent` (#FF8AB8), `bg-mint` (#7FE3CC), `bg-lavender` (#C7B9FF)
- Border radius: Cards = `rounded-lg` (12px), Buttons = `rounded-md` (8px), Pills = `rounded-pill` (24px)
- Dark mode: Use `dark:` modifiers (e.g., `dark:bg-background`)

### Common Patterns
```tsx
// Spacing: p-4, m-6, gap-3
// Flexbox: flex-1, flex-row, items-center, justify-between
// Colors: bg-primary, text-foreground, border-border
// Typography: text-xl, font-bold, font-semibold
```

## Component Rules

### UI Components
- Use components from `components/ui/` (React Native Reusables)
- Install new components: `npx @react-native-reusables/cli@latest add <name>`
- All components use `cn()` for className merging and CVA for variants

### Component Architecture
- **Functional only**: No class components
- **Self-contained components**: Components manage their own state and UI interactions
- **Minimize prop drilling**: Pass only essential data/callbacks (2-3 props max)
- **Parent responsibility**: Orchestration, data fetching, final persistence only
- **Forms**: Use local `useState`, submit via React Query mutation

### Platform-Specific Styles
- Wrap web-only styles in `Platform.select({ web: 'hover:...' })`
- Use in CVA variants for buttons and interactive elements

## TypeScript Rules

- **Strict mode**: Enabled, `any` banned by ESLint
- **Type inference**: Use Drizzle's `$inferSelect`/`$inferInsert`
- **Path alias**: `@/*` ‚Üí project root
- **No type assertions**: Use type guards instead of `as` assertions
- **as const**: Only for const assertions on literals

```tsx
// ‚úÖ Type guard
function isRecord(value: unknown): value is Record<string, unknown> {
  return value !== null && typeof value === 'object';
}

// ‚úÖ as const for literals
const COLORS = ['red', 'blue'] as const;

// ‚ùå No type assertions
const value = data as SomeType;
```

## ESLint Rules (Strict)

- **No classes**: Functional patterns only
- **No `any`**: Fails build
- **No type assertions**: Use type guards
- **No unused vars**: Enforced (prefix `_` to ignore)
- **No eslint-disable comments**: Fix issues, don't suppress

## Database Rules

- **Timestamps**: Unix seconds only (`Math.floor(Date.now() / 1000)`), never milliseconds
- **Modules**: `database/*.ts` with `save{Activity}`, `get{Activities}`
- **Auto-inject**: `babyId` via `requireActiveBabyProfileId()`
- **Migrations**: Auto-run on startup, generate with `npm run db:generate`

## React Query Patterns

### Save Pattern
```tsx
const mutation = useMutation({
  mutationFn: (payload) => saveFeeding(payload),
  onSuccess: () => {
    queryClient.invalidateQueries({ queryKey: FEEDINGS_QUERY_KEY });
    showNotification(t('common.saveSuccess'), 'success');
    setTimeout(() => router.back(), 500); // Delay for notification visibility
  },
  onError: (error) => {
    console.error('Failed to save:', error);
    showNotification(t('common.saveError'), 'error');
  },
});
```

### Edit Mode Pattern
```tsx
const { id } = useLocalSearchParams<{ id: string }>();
const isEditing = !!id;

const { data: existingData } = useQuery({
  queryKey: feedingByIdKey(parseInt(id)),
  queryFn: () => getFeedingById(parseInt(id)),
  enabled: isEditing, // Important: avoid fetching when creating
});
```

### Mutation with Update Support
```tsx
const mutation = useMutation({
  mutationFn: async (payload: FeedingPayload) => {
    if (isEditing && id) {
      await updateFeeding(parseInt(id), payload);
    } else {
      await saveFeeding(payload);
    }
  },
  onSuccess: () => {
    queryClient.invalidateQueries({ queryKey: FEEDINGS_QUERY_KEY });
    showNotification(t('common.saveSuccess'), 'success');
    setTimeout(() => router.back(), 500);
  },
  onError: (error) => {
    console.error('Failed to save:', error);
    showNotification(t('common.saveError'), 'error');
  },
});
```

## Authentication Rules

- **Clerk hooks**: `useSignIn()`, `useSignUp()`, `useUser()`, `useAuth()`, `useSSO()`
- **Auth pattern**: Use `setActive({ session })` after successful sign-in
- **Auth screens**: Located in `app/(auth)/`

## Localization Rules

- **System**: `LocalizationProvider` + `useLocalization()` hook
- **Usage**: `const { t } = useLocalization(); t('feeding.types.breast')`
- **Files**: `localization/translations/*.ts`

## Routing Rules

- **Expo Router**: File-based routing
- **Modals**: Activity screens use `presentation: 'modal'`
- **Navigation**: `router.push()`, `router.back()`, `useLocalSearchParams<{ id: string }>()`

## Common Gotchas

- **ScrollView**: Use `contentContainerClassName` for scroll content styling, not `className`
- **Notification delay**: Add 500ms `setTimeout()` before `router.back()` after notifications
- **useNotification**: Import as `const { showNotification } = useNotification()`
- **Edit mode queries**: Always set `enabled: isEditing` to avoid unnecessary fetches
- **React Native Reusables**: Not all shadcn/ui components available - check `docs/ui-components-library.md`
- **TabsTrigger children**: Must wrap text in `<Text>` component
- **NativeWind shadow classes bug (CRITICAL)**: Shadow utility classes (`shadow-md`, `shadow-sm`, `shadow-lg`, `shadow-lavender/15`, `shadow-black/5`, etc.) on `Pressable` or `TouchableOpacity` components cause the error: `"Couldn't find a navigation context. Have you wrapped your app with 'NavigationContainer'?"`. This is a known NativeWind 4 bug where shadow classes internally require navigation context during style computation.

  **Affected components**: `Pressable`, `TouchableOpacity`, and any component that renders these (e.g., `Card` with `onPress` prop)

  **Safe components**: `View` components can use shadow classes safely - the bug only affects pressable components.

  **Workaround**: Always use React Native's native `style` prop for shadows on pressable components:

```tsx
// ‚ùå DON'T - Causes navigation context error
<Pressable className="shadow-md shadow-lavender/15">
<Card className="shadow-sm" onPress={handlePress}>
<TouchableOpacity className="shadow-sm shadow-black/5">

// ‚úÖ DO - Use native style prop
<Pressable
  style={{
    shadowColor: 'rgba(199, 185, 255, 0.15)',
    shadowOffset: { width: 0, height: 4 },
    shadowOpacity: 1,
    shadowRadius: 6,
    elevation: 4, // Required for Android
  }}>

// ‚úÖ DO - View components are safe
<View className="shadow-sm shadow-black/5">
```

  **Files already fixed**: `components/ui/card.tsx`, `app/(tabs)/settings.tsx`, `app/(profiles)/profile-selection.tsx`, `app/(tracking)/feeding.tsx`, `pages/easy-schedule/components/SchedulePhaseCard.tsx`

## Component Organization

- **Page components**: Extract complex tab content to `pages/{feature}/` folders
- **Reusable components**: Place in `components/` or `pages/{feature}/components/`
- **UI primitives**: Use `components/ui/` for React Native Reusables components

## Development Commands

- **Type check**: `npm run type-check` (fails on `any` types)
- **Lint**: `npm run lint:fix` (enforces no classes, no unused vars, no `any`)
- **Format**: `npm run format` (Prettier with Tailwind plugin)
- **DB generate**: `npm run db:generate` (creates migration)
- **DB studio**: `npm run db:studio` (browse database)

## File Structure

- `app/_layout.tsx`: App initialization, Clerk provider, migrations
- `global.css`: Theme CSS variables
- `tailwind.config.js`: Tailwind config with brand colors
- `lib/utils.ts`: `cn()` utility for className merging
- `components/ui/*`: React Native Reusables component library
- `db/schema.ts`: Database schema
- `docs/color-migration.md`: Complete color mapping guide

## Migration Status

- ‚úÖ **Completed**: All tab screens, feeding screen, auth screens
- üîÑ **In progress**: Remaining activity screens, onboarding
- **When editing files**: Prefer migrating StyleSheet usage to Tailwind classes

