# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

default_platform(:ios)

platform :ios do
  desc "Download metadata from App Store Connect"
  lane :download_metadata do
    # Note: Fastlane's deliver action only uploads metadata
    # To download iOS metadata, you need to:
    # 1. Manually download from App Store Connect, OR
    # 2. Use App Store Connect API, OR
    # 3. The metadata files should already exist in fastlane/metadata/ios/
    UI.important("iOS metadata download:")
    UI.important("1. Download manually from App Store Connect")
    UI.important("2. Or ensure metadata files exist in ./fastlane/metadata/ios/")
    UI.important("3. Metadata structure is already set up - just edit the .txt files")
  end

  desc "Upload metadata to App Store Connect"
  lane :upload_metadata do
    deliver(
      skip_binary_upload: true,
      skip_screenshots: true,
      force: true,
      app_identifier: "com.hunght.BabyEase",
      metadata_path: "./fastlane/metadata/ios",
      team_id: "111225803", # "Hung Hoang The" team
      app_version: "1.0",
      platform: "ios"
    )
  end

  desc "Download screenshots from App Store Connect"
  lane :download_screenshots do
    # Note: deliver action only uploads. Screenshots need to be downloaded manually
    UI.important("iOS screenshots download requires manual setup or App Store Connect API")
    UI.important("You can download screenshots manually from App Store Connect")
  end

  desc "Upload screenshots to App Store Connect"
  lane :upload_screenshots do
    deliver(
      skip_binary_upload: true,
      skip_metadata: true,
      force: true,
      app_identifier: "com.hunght.BabyEase",
      screenshots_path: "./fastlane/metadata/ios/screenshots",
      team_id: "111225803", # "Hung Hoang The" team
      app_version: "1.0",
      platform: "ios",
      app_review_information: {
        "contact_first_name" => "Hung",
        "contact_last_name" => "Hoang",
        "contact_phone" => "+1 206 555 0100",
        "contact_email" => "hth321@gmail.com"
      }
    )
  end
end

platform :android do
  desc "Download metadata from Google Play Console"
  lane :download_metadata do
    download_from_play_store(
      package_name: "com.hunght.BabyEase",
      metadata_path: "./fastlane/metadata/android"
    )
  end

  desc "Upload metadata to Google Play Console"
  lane :upload_metadata do |options|
    skip_changelogs = options[:skip_changelogs] || false
    version_code = options[:version_code] || 4  # Default to latest version code

    supply(
      skip_upload_apk: true,
      skip_upload_aab: true,
      skip_upload_metadata: false,
      skip_upload_images: false,
      skip_upload_screenshots: false,
      skip_upload_changelogs: skip_changelogs,
      version_code: skip_changelogs ? nil : version_code,
      package_name: "com.hunght.BabyEase",
      metadata_path: "./fastlane/metadata/android",
      json_key: "./google-play-key.json"
    )
  end

  desc "Download screenshots from Google Play Console"
  lane :download_screenshots do
    download_from_play_store(
      package_name: "com.hunght.BabyEase",
      metadata_path: "./fastlane/metadata/android"
    )
  end

  desc "Upload screenshots to Google Play Console"
  lane :upload_screenshots do
    supply(
      skip_upload_apk: true,
      skip_upload_aab: true,
      skip_upload_metadata: true,
      skip_upload_images: false,
      skip_upload_screenshots: false,
      package_name: "com.hunght.BabyEase",
      metadata_path: "./fastlane/metadata/android",
      json_key: "./google-play-key.json"
    )
  end

  desc "Check Android release status and tracks"
  lane :check_release_status do
    UI.message("ğŸ“± Checking Android release status for com.hunght.BabyEase...")
    UI.message("")

    package_name = "com.hunght.BabyEase"
    json_key = "./google-play-key.json"
    tracks = ["production", "beta", "alpha", "internal"]

    begin
      # Test connection first
      supply(
        skip_upload_apk: true,
        skip_upload_aab: true,
        skip_upload_metadata: true,
        skip_upload_images: true,
        skip_upload_screenshots: true,
        skip_upload_changelogs: true,
        package_name: package_name,
        json_key: json_key,
        validate_only: true
      )
      UI.success("âœ… Successfully connected to Google Play Console")
      UI.message("")

      # Get release information for each track
      tracks.each do |track|
        UI.message("ğŸ“Š Checking #{track.upcase} track...")
        begin
          version_codes = google_play_track_version_codes(
            package_name: package_name,
            track: track,
            json_key: json_key
          )

          release_names = google_play_track_release_names(
            package_name: package_name,
            track: track,
            json_key: json_key
          )

          if version_codes && version_codes.length > 0
            UI.success("   Version Codes: #{version_codes.join(', ')}")
            UI.success("   Release Names: #{release_names.join(', ') if release_names}")
            UI.message("   Latest Version Code: #{version_codes.first}")
            if release_names && release_names.length > 0
              UI.message("   Latest Release Name: #{release_names.first}")
            end
          else
            UI.important("   No releases found in #{track} track")
          end
        rescue => ex
          UI.important("   âš ï¸  Could not retrieve #{track} track info: #{ex.message}")
        end
        UI.message("")
      end

      UI.message("ğŸ“Š For more detailed status, visit:")
      UI.message("   https://play.google.com/console/developers")
      UI.message("   Navigate to: Release > Production")

    rescue => ex
      UI.important("âš ï¸  Could not connect to Google Play Console API")
      UI.important("   Error: #{ex.message}")
      UI.important("   Please check your google-play-key.json file")
      UI.message("")
      UI.message("ğŸ“Š You can still check release status manually at:")
      UI.message("   https://play.google.com/console/developers")
    end
  end

  desc "Promote latest internal release to production"
  lane :promote_to_production do
    package_name = "com.hunght.BabyEase"
    json_key = "./google-play-key.json"

    UI.message("ğŸ” Detecting latest version from internal track...")

    # Get the latest version code from internal track
    version_codes = google_play_track_version_codes(
      package_name: package_name,
      track: "internal",
      json_key: json_key
    )

    if version_codes.nil? || version_codes.empty?
      UI.user_error!("âŒ No versions found in internal track. Please upload a build first.")
    end

    target_version_code = version_codes.first
    UI.success("ï¿½ Found latest internal version code: #{target_version_code}")
    UI.message("")
    UI.message("ğŸš€ Promoting version code #{target_version_code} to production...")
    UI.message("")

    begin
      # Promote from internal to production
      supply(
        package_name: package_name,
        json_key: json_key,
        track: "internal",
        track_promote_to: "production",
        version_code: target_version_code,
        skip_upload_apk: true,
        skip_upload_aab: true,
        skip_upload_metadata: true,
        skip_upload_images: true,
        skip_upload_screenshots: true,
        skip_upload_changelogs: true
      )
      UI.success("âœ… Successfully promoted version code #{target_version_code} to PRODUCTION")
      UI.message("")
      UI.message("Note: Previous versions will be automatically superseded in production")
    rescue => ex
      UI.important("âš ï¸  Could not promote to production: #{ex.message}")
      UI.important("")
      UI.important("Manual steps:")
      UI.important("1. Visit: https://play.google.com/console/developers")
      UI.important("2. Go to: Release > Internal testing")
      UI.important("3. Find version code #{target_version_code}")
      UI.important("4. Click 'Promote release' > Select 'Production'")
    end
  end

  desc "Promote latest internal release to beta track"
  lane :promote_to_beta do
    package_name = "com.hunght.BabyEase"
    json_key = "./google-play-key.json"

    UI.message("ğŸ” Detecting latest version from internal track...")

    version_codes = google_play_track_version_codes(
      package_name: package_name,
      track: "internal",
      json_key: json_key
    )

    if version_codes.nil? || version_codes.empty?
      UI.user_error!("âŒ No versions found in internal track. Please upload a build first.")
    end

    target_version_code = version_codes.first
    UI.success("ï¿½ Found latest internal version code: #{target_version_code}")
    UI.message("")
    UI.message("ğŸš€ Promoting version code #{target_version_code} to beta...")
    UI.message("")

    begin
      supply(
        package_name: package_name,
        json_key: json_key,
        track: "internal",
        track_promote_to: "beta",
        version_code: target_version_code,
        skip_upload_apk: true,
        skip_upload_aab: true,
        skip_upload_metadata: true,
        skip_upload_images: true,
        skip_upload_screenshots: true,
        skip_upload_changelogs: false
      )
      UI.success("âœ… Successfully promoted version code #{target_version_code} to BETA")
      UI.message("")
      UI.message("Note: Previous versions will be automatically superseded in beta")
    rescue => ex
      UI.important("âš ï¸  Could not promote to beta: #{ex.message}")
    end
  end

  desc "Promote latest internal release to alpha track"
  lane :promote_to_alpha do
    package_name = "com.hunght.BabyEase"
    json_key = "./google-play-key.json"

    UI.message("ğŸ” Detecting latest version from internal track...")

    version_codes = google_play_track_version_codes(
      package_name: package_name,
      track: "internal",
      json_key: json_key
    )

    if version_codes.nil? || version_codes.empty?
      UI.user_error!("âŒ No versions found in internal track. Please upload a build first.")
    end

    target_version_code = version_codes.first
    UI.success("ï¿½ Found latest internal version code: #{target_version_code}")
    UI.message("")
    UI.message("ğŸš€ Promoting version code #{target_version_code} to alpha...")
    UI.message("")

    begin
      supply(
        package_name: package_name,
        json_key: json_key,
        track: "internal",
        track_promote_to: "alpha",
        version_code: target_version_code,
        skip_upload_apk: true,
        skip_upload_aab: true,
        skip_upload_metadata: true,
        skip_upload_images: true,
        skip_upload_screenshots: true,
        skip_upload_changelogs: false
      )
      UI.success("âœ… Successfully promoted version code #{target_version_code} to ALPHA")
      UI.message("")
      UI.message("Note: Previous versions will be automatically superseded in alpha")
    rescue => ex
      UI.important("âš ï¸  Could not promote to alpha: #{ex.message}")
    end
  end

  desc "Promote latest internal release to both Beta and Alpha tracks"
  lane :promote_to_testing_tracks do
    UI.message("ğŸš€ Promoting latest internal release to Beta and Alpha tracks...")
    UI.message("")

    UI.message("Step 1: Promoting to Beta...")
    promote_to_beta

    UI.message("")
    UI.message("Step 2: Promoting to Alpha...")
    promote_to_alpha

    UI.message("")
    UI.success("âœ… Successfully promoted to Beta and Alpha tracks")
    UI.message("")
    UI.message("Note: Previous versions are now automatically superseded in all tracks")
  end

  desc "Complete process: Promote latest internal release to all tracks (Production, Beta, Alpha)"
  lane :promote_all_tracks do
    UI.message("ğŸš€ Starting promotion process...")
    UI.message("")
    UI.message("This will promote the latest internal release to all tracks")
    UI.message("")

    # Step 1: Promote to production
    UI.message("Step 1: Promoting to Production...")
    promote_to_production

    UI.message("")
    UI.message("Step 2: Promoting to Beta and Alpha...")
    promote_to_testing_tracks

    UI.message("")
    UI.success("âœ… Promotion process completed!")
    UI.message("")
    UI.message("ğŸ“Š All tracks now have the latest version, previous versions are superseded")
    UI.message("")
    UI.message("Check the results:")
    UI.message("   fastlane android check_release_status")
  end
end

